---
- name: rm luna directory
  file:
    path: "{{item}}"
    state: absent
  with_items:
     - "{{jms.APP_DIR}}/luna"
     - "{{jms.APP_DIR}}/luna.tar.gz"
     - /tmp/luna-master.zip
     - /tmp/luna-master


- name: download  luna src package
  shell:
    wget -O luna-master.zip "{{luna_url}}"
  args:
    chdir: "/tmp/"
  register: luna_src_dl
  until: luna_src_dl.rc == 0 #判断条件包含特定字符串cat
  retries: 5  #重试5次
  delay: 5    #间隔5s


- name: unarchive luna src package
  unarchive:
    src: "/tmp/luna-master.zip"
    dest: "/tmp/"
    remote_src: yes
    mode: 0755


- name: get luna latest version
  shell: |
    cat package.json |grep version|awk -F'"' '{print $4}'
  args:
    chdir: /tmp/luna-master/
  register: luna_version

- name: download  luna  package
  shell:
    wget -O luna.tar.gz "https://github.com/jumpserver/luna/releases/download/{{luna_version.stdout}}/luna.tar.gz"
  args:
    chdir: "{{jms.APP_DIR}}/"
  register: luna_dl
  until: luna_dl.rc == 0 #判断条件包含特定字符串cat
  retries: 5  #重试5次
  delay: 5    #间隔5s



- name: unarchive luna package
  unarchive:
    src: "{{jms.APP_DIR}}/luna.tar.gz"
    dest: "{{jms.APP_DIR}}/"
    mode: 0755



- name: chmod  luna directory
  file:
    path: "{{jms.APP_DIR}}/luna"
    state: directory
    owner: "{{manager_user}}"
    group: "{{manager_group}}"
    recurse: yes
    mode: 0755
